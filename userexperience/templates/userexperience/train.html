{% extends "userexperience/layout.html" %}
{% block title %}
Train
{% endblock %}
{% block content %}
<p>Training page for Narrative Flow Analysis.</p>
</br>
<p>Enter Text or Select File</p>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
  
  {% if text %}
    <input type="checkbox" id="csv" name="csv" onclick="csv_clicked()">
    <label for="csv"> Treat CSVs files as Tables </label><br>
    
  {% else %}
    <input type="checkbox" id="csv" name="csv" onclick="csv_clicked()" checked>
    <label for="csv"> Treat CSVs files as Tables </label><br>
    
  {% endif %}
  <input type="file" name="myfile" id="myfile" onchange="getfile_changed()">
  <button type="submit" id="file_upload" name="file_upload" disabled>Get Text</button>
</form>
{% if uploaded_file_url %}
  <p>File uploaded at: <a href="{{ uploaded_file_url }}">{{ uploaded_file_url }}</a></p>
{% endif %}
</br>


{% if text %}
<div id="text">
  <p>Text To Test</p>
  <textarea rows="20" cols="100">{{ result }} </textarea>
</div>
{% elif json_data %}
  <div id="json">
    <p>Select JSON Attributes to Use</p>
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <table>
        
        <tr>
          <th id="json_header_attribute">Attributes</th>
          <th id="json_header_value">Values</th>
        </tr>
        
        {% for key, value in json_data.items %}
        <tr>
          <td>
            <input type="checkbox" id="{{ key }}" name="json_key" onclick="json_clicked(this)">
            <label for="{{ key }}">{{ key }}</label>
          </td>
          <td>
            <textarea rows=3 cols="100" name="{{key}}">{{ value }}</textarea>
          </td>
        </tr>
        
        {% endfor %}
      </table>
    </form> 
  </div>
{% else %}
  <div id="text" style="display: none">
    <p>Text To Test</p>
    <textarea rows="20" cols="100">{{ result }} </textarea>
  </div>
  <div id="showtable">
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      
      {% if table_data %}
        <h2 class="text-center"><u>Table Results</u></h2><br>
        {% if first_view %}
          <p>Select a Column to Use</p>
        {% endif %}
        <button type="submit" id="table_submit" name="table_submit" disabled>Clean Text</button>
        <input type="hidden" id="selected_column" name="selected_column">
        <table>
          <th id="csvheader">
            <tr>
              {% if first_view %}
                <td>
                  <input type="checkbox" name="column_check" id="{{ index_name }}" onclick="column_clicked(this)">
                  <label for="index"> {{index_name}} </label><br>
                </td>
                {% for c in column_names %}
                  <td>
                    <input type="checkbox" name="column_check" id="{{ c }}" onclick="column_clicked(this)">
                    <label for="index"> {{ c }} </label><br>
                  </td>
                {% endfor %}
              {% endif %}
              {% if cleaned %}
                  <td>{{index_name}}</td>
              {% endif %}
            </tr>
          </th>
          <tbody>
            {% for td in table_data %}
              <tr>
                {% for key, value in td.items %}
                <td><textarea rows=3 cols="100" name="{{key}}_[{{forloop.parentloop.counter}}]">{{ value }}</textarea></td>
                {% endfor %}
              </tr>
            {% endfor %}          
          </tbody>
        </table>
      {% endif %}
    </form>
  </div>
{% endif %}

<script type = "text/javascript">
function getfile_changed(){
  var btn_GetText = document.getElementById("file_upload");
  btn_GetText.disabled = false;
}
function column_clicked(col){
  var myCheckbox = document.getElementsByName("column_check");
  var selected_column = document.getElementById("selected_column");
  var table_submit = document.getElementById("table_submit");
  Array.prototype.forEach.call(myCheckbox,function(el){
    el.checked = false;
  });
  col.checked = true;
  selected_column.value = col.getAttribute("id");
  table_submit.disabled = false;
}

function csv_clicked() {
  var csv = document.getElementById("csv");
  var text = document.getElementById("text");
  var showtable = document.getElementById("showtable")
  if (csv.checked) {
    text.style.display = "none";
    showtable.style.display = "initial";
  }
  else {
    text.style.display = "initial";
    showtable.style.display = "none";
  }
}
function json_clicked(att){
  let rowname = att.getAttribute("id");
  let reg = /_\d+_/g;
  let matchrow = rowname.replace(reg,"_\\d+_")
  var json_key = document.getElementsByName("json_key");
  const regex = new RegExp(matchrow)
  Array.prototype.forEach.call(json_key,function(ea){
    var rowname = ea.getAttribute("id");
    if (regex.test(rowname)) {
      if (att.checked) {
        ea.checked = true;
      }
      else {
        ea.checked = false;
      }
      
    }
  })
}
</script>

<p><a href="{% url 'home' %}">Return to home</a></p>
{% endblock %}